name: Setup SSL (Certbot)
on: workflow_dispatch

jobs:
  setup-ssl:
    runs-on: ubuntu-latest
    steps:
      - name: Install SSL Certificate
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "Starting SSL setup..."
            # Check if certbot is installed
            if ! command -v certbot &> /dev/null; then
                echo "Certbot not found. Installing..."
                echo "${{ secrets.VPS_PASSWORD }}" | sudo -S apt-get update
                echo "${{ secrets.VPS_PASSWORD }}" | sudo -S apt-get install -y certbot python3-certbot-nginx
            fi
            
            # Run Certbot non-interactively
            # --nginx: Use Nginx plugin
            # --register-unsafely-without-email: No email required (standard simplified registration)
            # --agree-tos: Agree to terms
            # --redirect: Update Nginx to redirect HTTP -> HTTPS
            echo "Requesting certificate for it.filatiev.pro..."
            echo "${{ secrets.VPS_PASSWORD }}" | sudo -S certbot --nginx -d it.filatiev.pro --register-unsafely-without-email --agree-tos --redirect
            
            echo "Reloading Nginx..."
            echo "${{ secrets.VPS_PASSWORD }}" | sudo -S systemctl reload nginx
            echo "SSL Setup Complete!"
