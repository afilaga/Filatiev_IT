name: Emergency Fix Nginx
on: workflow_dispatch
jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "Checking Nginx configuration..."
            sudo nginx -t || true
            
            echo "Disabling potentially broken site it.filatiev.pro..."
            if [ -f /etc/nginx/sites-enabled/it.filatiev.pro ]; then
                sudo rm /etc/nginx/sites-enabled/it.filatiev.pro
                echo "Removed symlink."
            fi
            
            echo "Testing config again..."
            if sudo nginx -t; then
                echo "Config valid. Reloading Nginx..."
                sudo systemctl reload nginx
                echo "Nginx reloaded. Other sites should be UP."
            else
                echo "Config STILL invalid. Checking other sites..."
                ls -l /etc/nginx/sites-enabled/
            fi
